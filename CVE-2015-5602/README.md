# CVE-2015-5602

This is a simple path parsing issue with the Sudo program. It is not a remote code execution vulnerability directly, but it allows for privilege
escalation.

# Vulnerability

This vulnerability is described here: https://bugzilla.sudo.ws/show_bug.cgi?id=707. The main idea is that adding two wildcards in the path for a file
that is defined as editable in sudoedit, a user can create a symlink to a file they don't have permissions to access, then access it using the parsing
vulnerability. As stated in the post, best practice would be to not allow users to run things as root if they have write permissions, but this is
definitely something that someone could do as a mistake.

# Expliot

The exploit is mostly based on the entry in the `/etc/sudoers` file. Essentially it looks like this:
```
testuser ALL=(root) NOPASSWD: sudoedit /*/*/test.txt
```
The path defined can lead to any user writeable directory like: `/home/*/*/test.txt` or `/tmp/*/*/test.txt` as long as the file is in a user writeable
directory and there are two wildcards. The exploit works by doing a symbolic link from the test.txt file to a root only file (like /etc/sudoers). This
is easily done by the user with `ln -s /etc/sudoers /tmp/s/o/test.txt`. Then running sudoedit on that file will allow root editing.

### Running the exploit

To test this exploit, first go to `vulnerable/` in this repo. Then you can build the container with:
```
docker build -t cve-2015-5602:vuln ./.
```
and run it with
```
docker run -it cve-2015-5602:vuln
```
The `privesc.sh` file can be run with:
```bash
bash ./privesc.sh
```
which will open the `/etc/sudoers` file allowing the user to edit that file and give them escalated privileges.

# Patch

The patch is an important part of understanding this exploit. Since the parser wasn't necessarily the issue, the solution reflected that. In the
patch diff ([here](https://bugzilla.sudo.ws/attachment.cgi?id=466&action=diff)) you can see that on line 287 this was added:
```c
subdfd = openat(dfd, path, O_RDONLY | (is_writable ? O_NOFOLLOW : 0), 0);
```
This line essentially checked if the file is writeable and a symlink. If it is both, the file cannot be opened. This means that non-symlink files may
still be able to be accessed, but by the definition of the line in the sudoers file, this would be intended.

### Attempting the exploit

If you try to run the exploit with the patched version you will get:
```
sudoedit: /tmp/s/o/test.txt: editing symbolic links is not permitted
```

# Unintended Consequences

The one potential issue with this is that any symlinked file that is writeable would not be able to be accessed with this line added. For better
security, this shouldn't be possible anyways, but this is just one thing I noticed from the code. 

# What can be learned

This vulnerability was relatively simple exploit considering it is a simple permissions issue, but it's important to look at the approach the devs
took with the patch. If the devs had tried to improve just the parser to prevent unintended file access, it could leave holes for future attacks. That
type of thinking is important to look for in patch diffs when doing vulnerability research. If they don't solve the root cause of the issue, there
remains the possibility of new exploits.
