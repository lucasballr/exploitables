# [CVE-2013-2028](https://nvd.nist.gov/vuln/detail/CVE-2013-2028)

This is a vulnerability in the Nginx web server found in 2013. This is an old exploit for a stack overflow vulnerability in the nginx web server. This works by taking advantage of a bug in the
`http_parse_chunked()` function that was newly added in this version of nginx. The format of a chunked request is supposed to look like this: 
```
size \r\n
data \r\n
size \r\n
data \r\n
...
```
Where each data section is prepended by the size of it. The issue came with extremely large data sections. If the request had a size that was
extremely large, the program wouldn't have the stack space for the request data resulting in a stack overflow. This exploit takes advantage of this
stack overflow in order to create a full chain exploit to get a shell on the web server host.

# Testing this exploit

To test this out, you'll need to build the docker container with the docker build command:
```bash
cd CVE-2013-2028 
docker build -t cve-2013-2028 . 
```
Then you need to run the docker container in privileged mode in order to give the container proper access to the sockets.
```bash
docker run -d --privileged --name testing cve-2013-2028:latest
```
Next step is to find the container IP address (you can skip this step if you had forwarded the container port 80).
```bash
docker inspect testing | grep "IPAddress"
```
Then you can run the exploit
```bash
./e.py <IPAddress> 80
```
Here is what it looks like:
```bash
./e.py 172.17.0.2 80
[*] '/home/lucasballr/cyber/exploitables/CVE-2013-2028/nginx'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    FORTIFY:    Enabled
    Stripped:   No
    Debuginfo:  Yes
Brute Forcing the stack cookie
BYTE 204 FOUND
BYTE 225 FOUND
BYTE 185 FOUND
BYTE 162 FOUND
BYTE 15 FOUND
BYTE 117 FOUND
BYTE 233 FOUND
BYTE 0 FOUND
Canary found:  b'\xcc\xe1\xb9\xa2\x0fu\xe9\x00'
Press enter to exploit
sh: turning off NDELAY mode
YOU HAVE BEEN PWNED
$
```
# Notes

This was all debugged and written by hand using my custom docker container with nginx built without a stack cookie. This meant that the ROP chain had
to be rebuilt when I wanted to run the exploit with a stack cookie. In the end, this exploit taught me a lot about the process of debugging a program
and building a full chain exploit.

# Alternative exploit

There was an alternative version of this exploit that was created just for the purpose of causing a DOS on the nginx server. If the request size was a
negative number, the chunk parser would interpret this as a massive size, but instead of overflowing the stack, it would cause a DOS in the parent
program. This is likely due to an indefinite hang in the socket that got opened by the connection to the server.

# The patch

A patch was added in the next version of nginx that would read the size of the chunk and make sure it was larger than 0 and smaller than the max chunk
size. This prevented both types of exploits.
