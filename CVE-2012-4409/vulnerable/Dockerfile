# Start from a Debian base image
FROM debian:stable-slim

# Set environment variables to avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Update package list and install required tools
RUN apt-get update && \
    apt-get install -y wget build-essential gcc-multilib g++-multilib autoconf automake libtool pkg-config

# Set CFLAGS and LDFLAGS for 32-bit compilation
ENV CFLAGS="-m32"
ENV LDFLAGS="-m32"

# Set the versions and directories for mcrypt and its dependencies
ENV MCRYPT_VERSION=2.6.8
ENV LIBMCRYPT_VERSION=2.5.8
ENV LIBMHASH_VERSION=0.9.9.9
ENV MCRYPT_DIR=/tmp/mcrypt-${MCRYPT_VERSION}
ENV LIBMCRYPT_DIR=/tmp/libmcrypt-${LIBMCRYPT_VERSION}
ENV LIBMHASH_DIR=/tmp/mhash-${LIBMHASH_VERSION}

# Download and extract all libraries
RUN wget https://downloads.sourceforge.net/project/mhash/mhash/${LIBMHASH_VERSION}/mhash-${LIBMHASH_VERSION}.tar.gz -P /tmp && \
    wget https://downloads.sourceforge.net/project/mcrypt/Libmcrypt/${LIBMCRYPT_VERSION}/libmcrypt-${LIBMCRYPT_VERSION}.tar.gz -P /tmp && \
    wget https://sourceforge.net/projects/mcrypt/files/MCrypt/2.6.8/mcrypt-2.6.8.tar.gz -P /tmp && \
    tar -xvzf /tmp/mhash-${LIBMHASH_VERSION}.tar.gz -C /tmp && \
    tar -xvzf /tmp/libmcrypt-${LIBMCRYPT_VERSION}.tar.gz -C /tmp && \
    tar -xvzf /tmp/mcrypt-${MCRYPT_VERSION}.tar.gz -C /tmp

# Build and install libmhash
RUN cd ${LIBMHASH_DIR} && \
    ./configure CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" && \
    make && \
    make install

# Build and install libmcrypt
RUN cd ${LIBMCRYPT_DIR} && \
    ./configure CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" && \
    make && \
    make install

# Ensure the linker can find the libraries by refreshing the cache
RUN ldconfig

# Build and install Mcrypt
RUN cd ${MCRYPT_DIR} && \
    ./configure CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" --with-libmcrypt-prefix=/usr/local && \
    make && \
    make install

# Clean up installation files
RUN rm -rf ${LIBMHASH_DIR} ${LIBMCRYPT_DIR} ${MCRYPT_DIR} /tmp/mhash-${LIBMHASH_VERSION}.tar.gz /tmp/libmcrypt-${LIBMCRYPT_VERSION}.tar.gz /tmp/mcrypt-${MCRYPT_VERSION}.tar.gz

# Update LD_LIBRARY_PATH to include the directory where libraries are installed
ENV LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH}"

# Set the entry point to use Mcrypt
# CMD ["mcrypt", "--help"]
CMD ["/bin/bash"]
