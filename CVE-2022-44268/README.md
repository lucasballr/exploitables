# CVE-2022-44268

This is an example exploit for CVE-2022-44268.

### The Vulnerability

The vulnerability is a small piece of the `ReadOnePNGImage()` function within the `coders/png.c` file. This function essentially parses all of the
chunks in the png you wish to convert. One of the chunks that can be added to the png is a section in a tEXt chunk called the profile. When you add a
readable filename to this profile, the program will read the file and add the contents to the Raw Profile section of the "converted" image. This
creates an arbitrary read on any filesystem that this version of imagemagick is on.

The official CVE database says that this exploit affects versions 7.1.0-49, but after some testing I found that the patch wasn't added until version
7.1.0-52. This leaves two versions still vulnerable and not listed as vulnerable.


### The patch

The patch was added in version 7.1.0-52 [here](https://github.com/ImageMagick/ImageMagick/commit/05673e63c919e61ffa1107804d1138c46547a475) and [here](https://github.com/ImageMagick/ImageMagick/commit/09e738e84bd78c473771804de821e99f82d99219)
It basically just removed the resolution of the profile making the converted file just show the original profile as intended.


### The exploit

The exploit is relatively simple. The only thing you need to do is add a `tEXt` chunk in an existing png file that contains "profile" with the absolute path for the desired
file that you wish to obtain. Something like this: `"profile: /etc/passwd"`. The next step is to run some kind of conversion on the file in order to
force the ImageMagick program to run the `ReadOnePNGImage()` function. When this happens, the converted file will have the contents of the desired
file as long as the original file is readable by the user that runs the ImageMagick program. In the Docker example, the program is running as root
making to possible to read any file. In the real world, this conversion might be happening on a server somewhere not running as root, so it would
require the attacker to understand a little bit about the filesystem.

Considering the vulnerability description [here](https://www.metabaseq.com/imagemagick-zero-days/) explained the majority of the exploit and how it
works, there was minimal work to do for the exploit. The real effort is in understanding what exactly the modified part of the PNG is and how to add
that do make the exploit work. this can be done with the `pypng` library in python. It allows you to read the chunks of a PNG so you have an example.
Then it allows you to modify that list of chunks so that you have a full png to use for the exploit. 

### The environment

The example I've given here is a docker container that has compiled the most recent exploitable version of ImageMagick. This slightly differs from the
template docker container that I have in the program description because it required some extra dependencies in order to make sure the ImageMagick
program can read PNG files. I used the `checkinstall` program to verify that the libpng library is installed and ImageMagick can see it before
compiling. 

In a real-world scenario, the version would likely be hidden from the attacker making it a black-box pentesting environment and providing an advantage
to the defender.

## How to use

First, make sure you have all the necessary tools installed.
Required tools:
- [identify](https://man.archlinux.org/man/identify.1)
- [docker](https://wiki.archlinux.org/title/Docker)

Then you'll need to build the docker container:
```bash
docker build -t cve-2022-44268:v51 ./vulnerable
```
If you want to verify the patched version you can do that as well:
```bash
docker build -t cve-2022-44268:v52 ./patched
```
Then you can run the respective exploits:
```bash
cd vulnerable/ # or cd patched/
python3 e.py yinyang.png <desired_file_path>
```
In thr vulnerable one, you'll see the file appear in the current directory. In the patched one you'll see a message saying the exploit failed

## References

- https://github.com/ImageMagick/ImageMagick
- https://www.metabaseq.com/imagemagick-zero-days/
- https://nvd.nist.gov/vuln/detail/CVE-2022-44268


