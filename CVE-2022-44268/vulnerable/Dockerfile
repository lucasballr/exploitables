# Use a Debian base image
FROM debian:bullseye-slim

# Set environment variables to avoid user interaction during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary build dependencies
RUN sed -i 's|deb http://deb.debian.org/debian bullseye main|&\ndeb-src http://deb.debian.org/debian bullseye main|' /etc/apt/sources.list && \
    sed -i 's|deb http://deb.debian.org/debian bullseye-updates main|&\ndeb-src http://deb.debian.org/debian bullseye-updates main|' /etc/apt/sources.list && \
    sed -i 's|deb http://security.debian.org/debian-security bullseye-security main|&\ndeb-src http://security.debian.org/debian-security bullseye-security main|' /etc/apt/sources.list


RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    python3 \
    apt-utils \
    checkinstall \
    libpng-dev \
    libjpeg-dev \
    libx11-dev \
    libxext-dev \
    zlib1g-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libxml2-dev \
    gdb \
    wget \
    git \
    vim \
    locales

RUN apt-get build-dep -y imagemagick

RUN wget https://github.com/pwndbg/pwndbg/releases/download/2024.02.14/pwndbg_2024.02.14_amd64-portable.tar.gz
RUN tar -v -xf pwndbg_2024.02.14_amd64-portable.tar.gz
RUN ln -s /pwndbg/bin/pwndbg /bin/pwndbg

ENV IMAGEMAGICK_VERSION=7.1.0-51
RUN mkdir /imagemagick_build && cd /imagemagick_build \
    && wget https://github.com/ImageMagick/ImageMagick/archive/refs/tags/$IMAGEMAGICK_VERSION.tar.gz \
    && tar xzf $IMAGEMAGICK_VERSION.tar.gz \
    && cd ImageMagick-$IMAGEMAGICK_VERSION \
    && ./configure \
    && make \
    && checkinstall -D --install=yes --fstrans=no --pakdir "/imagemagick_build" \
     --pkgname imagemagick --backup=no --deldoc=yes --deldesc=yes --delspec=yes --default \
     --pkgversion "7.1.0-51" \
    && make distclean \
    && ldconfig


# Set the locale
RUN sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && \
    locale-gen
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

ENTRYPOINT ["convert"]
